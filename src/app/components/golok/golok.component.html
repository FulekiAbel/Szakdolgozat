<div>
    <div nz-row>
      <div nz-col nzFlex="2">
        <nz-card nzType="inner" style="margin-top: 16px;" nzTitle="√öj c√©lkit≈±z√©s">
          <form nz-form [formGroup]="goalForm" (ngSubmit)="createGoal()" class="custm-form">
            <label class="form-label">C√≠m</label>
            <nz-form-item>
              <nz-form-control nzErrorTip="Adj meg egy c√≠met!">
                <input type="text" nz-input formControlName="title" placeholder="C√©l c√≠me" />
              </nz-form-control>
            </nz-form-item>
            <label class="form-label">√ñsszeg</label>
            <nz-form-item>
              <nz-form-control nzErrorTip="Adj meg egy √∂sszeget!">
                <input type="number" nz-input formControlName="amount" placeholder="C√©l √∂sszege (Ft)" />
              </nz-form-control>
            </nz-form-item>
            <label class="form-label">D√°tum</label>
            <nz-form-item>
              <nz-form-control nzErrorTip="Adj meg egy d√°tumot!">
                <nz-date-picker style="width: 100%;" formControlName="targetDate"></nz-date-picker>
              </nz-form-control>
            </nz-form-item>
            <label class="form-label">Priorit√°s</label>
            <nz-form-item>
              <nz-form-control>
                <nz-select nzPlaceHolder="Priorit√°s" formControlName="priority">
                  <nz-option nzValue="Low" nzLabel="Alacsony"></nz-option>
                  <nz-option nzValue="Medium" nzLabel="K√∂zepes"></nz-option>
                  <nz-option nzValue="High" nzLabel="Magas"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
            <label class="form-label">Hozz√°j√°rul√°s gyakoris√°ga</label>
            <nz-form-item>
              <nz-form-control>
                <nz-select nzPlaceHolder="Hozz√°j√°rul√°s gyakoris√°ga" formControlName="frequency" (ngModelChange)="updateContributionAmount()">
                  <nz-option nzValue="weekly" nzLabel="Heti"></nz-option>
                  <nz-option nzValue="monthly" nzLabel="Havi"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>

            <nz-form-item>
                <nz-form-control>
                  <label style="display: flex; align-items: center; gap: 8px;">
                    <nz-switch formControlName="notificationsEnabled"></nz-switch>
                    <span>üîî √ârtes√≠t√©s k√©r√©se</span>
                  </label>
                </nz-form-control>
              </nz-form-item>
  
            <div *ngIf="calculatedAmount">
              <p><strong>{{ calculatedAmount | number: '1.0-0' }} Ft</strong>
                megtakar√≠t√°s sz√ºks√©ges {{ goalForm.value.frequency === 'weekly' ? 'hetente' : 'havonta' }} a c√©l el√©r√©s√©hez
                {{ goalForm.value.targetDate | date: 'yyyy.MM.dd' }}-ig.
              </p>
            </div>
            <button nz-button nzType="primary" nzBlock [disabled]="goalForm.invalid">C√©l l√©trehoz√°sa</button>
          </form>
        </nz-card>

      <div style="margin-top: 16px;">
        <nz-card nzType="inner" nzTitle="üìä C√©l√∂sszes√≠t≈ë">
          <div>
            <p>üéØ Akt√≠v c√©lok: <strong>{{ summary.active }}</strong></p>
            <p>‚úÖ Teljes√≠tve: <strong>{{ summary.completed }}</strong></p>
            <p>‚ö†Ô∏è Lej√°rt: <strong>{{ summary.expired }}</strong></p>
            <p>üí∏ Havi sz√ºks√©ges megtakar√≠t√°s az √∂sszes c√©lhoz: <strong>{{ summary.requiredMonthlySaving | number:'1.0-0' }} Ft</strong></p>
            <p>üßÆ M√©g sz√ºks√©ges √∂sszeg a folyamatban l√©v≈ë c√©lokhoz: <strong>{{ summary.totalRemaining | number:'1.0-0' }} Ft</strong></p>
            <p>üìà √Åtlagos el≈ërehalad√°s: <strong>{{ summary.averageProgress }}%</strong></p>
            <p>üè¶ Eddig f√©lretett √∂sszeg: <strong>{{ summary.totalSaved | number:'1.0-0' }} Ft</strong></p>
            <p>üöÄ Az √∂sszes c√©lod megval√≥s√≠t√°s√°hoz ennyit tett√©l m√°r f√©lre:</p>
            <nz-progress
            [nzPercent]="getTotalProgress()"
            [nzStrokeColor]="'#1890ff'"
            [nzStatus]="(summary.totalSaved >= summary.totalGoalAmount) ? 'success' : 'active'">
          </nz-progress>
          </div>
        </nz-card>
      </div>
    </div>
  
    <div nz-col nzFlex="3" style="margin-left: 20px;">
        <nz-card nzType="inner" style="margin-top: 16px;" nzTitle="C√©ljaid">
        <div class="filter-container">
          <div class="sort-select">
            <nz-select [(ngModel)]="sortBy" (ngModelChange)="sortGoals()">
              <nz-option nzValue="deadline" nzLabel="Lej√°rat szerint"></nz-option>
              <nz-option nzValue="progress" nzLabel="El≈ërehalad√°s szerint"></nz-option>
              <nz-option nzValue="priority" nzLabel="Priorit√°s szerint"></nz-option>
            </nz-select>
          </div>
          <div class="status-filters">
            <label class="status-label">Sz≈±r√©s st√°tusz szerint:</label>
            <label nz-checkbox [(ngModel)]="statusFilters.completed" (ngModelChange)="currentPage = 1">Teljes√≠tve</label>
            <label nz-checkbox [(ngModel)]="statusFilters.expired" (ngModelChange)="currentPage = 1">Lej√°rt</label>
            <label nz-checkbox [(ngModel)]="statusFilters.active" (ngModelChange)="currentPage = 1">Folyamatban</label>
          </div>
        </div>
              <ng-container *ngIf="goals$ | async as goals; else loading">
                <div nz-card-grid style="width: 100%; cursor: default;" *ngFor="let goal of paginatedGoals"
                [ngClass]="{
                  'goal-low': goal.priority === 'Low',
                  'goal-medium': goal.priority === 'Medium',
                  'goal-high': goal.priority === 'High'}">
                  <div nz-row>
                    <div nz-col nzSpan="24">
                      <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;"
                      (click)="toggleGoal(goal.id)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                          <h4 style="margin: 0; font-weight: bold; font-size: 18px;">{{ goal.title }}</h4>
                        </div>

                        <div style="display: flex; gap: 8px;">
                          <nz-tag
                            [nzColor]="goal.priority === 'Low' ? 'default' :
                                       goal.priority === 'Medium' ? 'gold' : 'red'"
                            style="font-weight: 600;">
                            {{goal.priority === 'Low' ? 'ALACSONY PRIORIT√ÅS' :
                              goal.priority === 'Medium' ? 'K√ñZEPES PRIORIT√ÅS' :
                              'MAGAS PRIORIT√ÅS'}}
                          </nz-tag>
                          <nz-badge
                            [nzStatus]="getGoalStatus(goal) === 'completed' ? 'success' :
                                        getGoalStatus(goal) === 'expired' ? 'error' : 'processing'"
                            [nzText]="getGoalStatus(goal) === 'completed' ? 'Teljes√≠tve' :
                                      getGoalStatus(goal) === 'expired' ? 'Lej√°rt' : 'Folyamatban'">
                          </nz-badge>
                        </div>
                      </div>

                      <p *ngIf="getMilestoneMessage(goal)">
                        {{ getMilestoneMessage(goal) }}
                      </p>
                      <p>üéØ C√©l √∂sszege: <strong>{{ goal.amount | number:'1.0-0' }} Ft</strong></p>
                      <p>üí∞ Eddig f√©lretett: <strong>{{ goal.savedAmount | number:'1.0-0' }} Ft</strong></p>
                      <nz-progress
                        [nzPercent]="getProgress(goal)"
                        [nzStrokeColor]="'#1890ff'"
                        [nzStatus]="getProgress(goal) === 100 ? 'success' : 'active'">
                      </nz-progress>
                      <p>üìÖ Hat√°rid≈ë: {{ goal.targetDate.toDate() | date: 'yyyy.MM.dd' }}</p>
              
                      <div *ngIf="getSuggestedContribution(goal) as suggestion">
                        <p>
                          ‚öôÔ∏è Ahhoz, hogy id≈ëben el√©rd a c√©lt:
                          <strong>{{ suggestion | number:'1.0-0' }} Ft</strong>
                          {{ goal.frequency === 'weekly' ? 'hetente' : 'havonta' }}
                          kell f√©lretenned.
                        </p>
                      </div>

                      <div *ngIf="expandedGoalId === goal.id">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer;">
                          <nz-switch
                            [(ngModel)]="goal.notificationsEnabled"
                            (ngModelChange)="toggleReminder(goal)">
                          </nz-switch>
                          <span>üîî √ârtes√≠t√©s k√©r√©se</span>
                        </label>

                        <div style="margin-top: 10px;">
                          <input nz-input type="number" placeholder="Hozz√°adott √∂sszeg (Ft)"
                            [(ngModel)]="contributionAmounts[goal.id]" style="width: 70%; margin-right: 8px;" />
                          <button nz-button nzType="default" (click)="addContribution(goal)">Hozz√°ad√°s</button>
                          <button nz-button nzType="dashed"(click)="fillFullAmount(goal)">Teljes√≠t√©s üíØ</button>
                        </div>

                        <div *ngIf="goal.contributions?.length" style="margin-top: 10px;">
                          <h5>üìú Hozz√°j√°rul√°sok:</h5>
                          <ul>
                            <li *ngFor="let c of goal.contributions">
                              {{ c.date.toDate() | date: 'yyyy.MM.dd' }} ‚Äì {{ c.amount | number:'1.0-0' }} Ft
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div>

                    <div nz-col nzSpan="24" style="text-align: right; margin-top: 10px;">
                      <span
                        nz-icon nzType="edit" nzTheme="fill"
                        style="color: blue; cursor: pointer; margin-right: 10px;"
                        (click)="editGoal(goal)">
                      </span>
                      <span
                        nz-icon nzType="delete" nzTheme="fill"
                        style="color: red; cursor: pointer;"
                        (click)="deleteGoal(goal.id)">
                      </span>
                    </div>
                  </div>
                </div>

            <nz-pagination
              [(nzPageIndex)]="currentPage"
              [nzTotal]="goals.length"
              [nzPageSize]="pageSize"
              [nzShowSizeChanger]="false"
              style="margin-top: 16px; text-align: center;">
            </nz-pagination>
          </ng-container>

          <ng-template #loading>
            <div style="text-align: center; padding: 20px;">
              <nz-spin nzSimple></nz-spin>
              <p>Bet√∂lt√©s...</p>
            </div>
          </ng-template>
        </nz-card>
      </div>
    </div>
  </div>